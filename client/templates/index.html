<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√ºvenli Mesajla≈üma & Dosya Transferi</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Tasarƒ±mƒ± */
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center; color: #333; }
        .container { width: 100%; max-width: 700px; background: #ffffff; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); margin: 20px; }
        h1 { text-align: center; color: #1e3c72; margin-bottom: 30px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; font-size: 0.9rem; }
        select, input[type="text"], textarea { width: 100%; padding: 12px 15px; border: 2px solid #e1e1e1; border-radius: 10px; box-sizing: border-box; font-family: 'Poppins', sans-serif; font-size: 1rem; transition: all 0.3s ease; background-color: #f9f9f9; }
        select:focus, input:focus, textarea:focus { border-color: #2a5298; background-color: #fff; outline: none; box-shadow: 0 0 0 4px rgba(42, 82, 152, 0.1); }
        textarea { resize: vertical; }
        small { display: block; margin-top: 5px; font-size: 0.85rem; color: #888; }
        .row { display: flex; gap: 20px; }
        .col { flex: 1; }
        
        .key-wrapper { display: flex; gap: 10px; }
        .key-wrapper input { flex: 1; }
        .random-btn { background: #e67e22; color: white; padding: 0 20px; border:none; border-radius:10px; cursor:pointer; font-weight:bold; transition: 0.3s; }
        .random-btn:hover { background: #d35400; transform: translateY(-2px); }

        .btn-group { display: flex; gap: 15px; margin-top: 25px; }
        button.main-btn { flex: 1; padding: 14px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #encryptBtn { background: linear-gradient(45deg, #11998e, #38ef7d); color: white; }
        #sendBtn { background: linear-gradient(45deg, #2a5298, #4a90e2); color: white; }
        button:disabled { background: #d6d6d6; color: #888; cursor: not-allowed; transform: none; box-shadow: none; }

        /* YENƒ∞: Dosya Y√ºkleme Alanƒ± */
        .file-upload-wrapper {
            border: 2px dashed #cbd5e0;
            background-color: #f8fafc;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            transition: 0.3s;
            cursor: pointer;
        }
        .file-upload-wrapper:hover { background-color: #edf2f7; border-color: #2a5298; }
        .file-upload-wrapper input[type="file"] { display: none; }
        .file-upload-label { cursor: pointer; color: #2a5298; font-weight: 600; display: block; }

        #result-area { margin-top: 30px; padding: 20px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; display: none; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .result-row { margin-bottom: 15px; display: flex; flex-direction: column; }
        .result-label { font-size: 0.85rem; font-weight: bold; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        .result-value { font-family: 'Roboto Mono', monospace; background: #2d3436; color: #00cec9; padding: 10px; border-radius: 6px; word-break: break-all; font-size: 0.95rem; letter-spacing: 0.5px; }
        
        .status-success { color: #00b894; font-weight: bold; }
        .status-error { color: #d63031; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>üõ°Ô∏è G√ºvenli Mesajla≈üma</h1>
    
    <div class="row">
        <div class="col form-group">
            <label for="algorithm">Algoritma</label>
            <select id="algorithm" onchange="resetForm()">
                <optgroup label="Modern (Hibrit)">
                    <option value="aes" selected>AES-128</option>
                    <option value="des">DES-64</option>
                </optgroup>
                <optgroup label="Klasik">
                    <option value="sezar">Sezar</option>
                    <option value="vigenere">Vigenere</option>
                    <option value="affine">Affine</option>
                    <option value="rail_fence">Rail Fence</option>
                    <option value="substitution">Substitution</option>
                    <option value="columnar">Columnar Transposition</option>
                    <option value="hill">Hill Cipher</option>
                    <option value="polybius">Polybius Square</option>
                    <option value="playfair">Playfair Cipher</option>
                    <option value="vernam">Vernam (One-Time Pad)</option>
                    <option value="root">Root Cipher (Route)</option>
                </optgroup>
            </select>
        </div>
        <div class="col form-group">
            <label for="mode">√áalƒ±≈üma Modu</label>
            <select id="mode" onchange="resetForm()">
                <option value="lib">K√ºt√ºphane (Library)</option>
                <option value="manual">Manuel (Eƒüitim)</option>
            </select>
        </div>
    </div>

    <div class="form-group">
        <label>Dosya veya Mesaj G√∂nder</label>
        <div class="file-upload-wrapper" onclick="document.getElementById('fileInput').click()">
            <span class="file-upload-label">üìÇ Dosya Se√ßmek ƒ∞√ßin Tƒ±kla (Resim, Word, PDF...)</span>
            <input type="file" id="fileInput" onchange="handleFileUpload()">
            <small id="file-name-display" style="margin-top: 5px; display: block; color: #666;">Hen√ºz dosya se√ßilmedi.</small>
        </div>
    </div>

    <div class="form-group">
        <label for="text">Mesaj / Dosya ƒ∞√ßeriƒüi (Base64)</label>
        <textarea id="text" rows="4" placeholder="Mesajƒ±nƒ±zƒ± buraya yazƒ±n veya yukarƒ±dan dosya se√ßin..."></textarea>
    </div>

    <div class="form-group">
        <label for="key">Anahtar</label>
        <div class="key-wrapper">
            <input type="text" id="key" placeholder="Anahtar">
            <button onclick="generateRandomKey()" class="random-btn">üé≤ Rastgele</button>
        </div>
        <small id="key-hint">L√ºtfen anahtar girin veya olu≈üturun.</small>
    </div>

    <div class="btn-group">
        <button onclick="performEncrypt()" id="encryptBtn" class="main-btn">üîí 1. ≈ûifrele</button>
        <button onclick="sendToServer()" id="sendBtn" class="main-btn" disabled>üöÄ 2. Server'a G√∂nder</button>
    </div>

    <div id="result-area">
        <h3>Sonu√ß Konsolu</h3>
        
        <div class="result-row">
            <span class="result-label">≈ûifreleme S√ºresi:</span>
            <div style="font-weight:bold; color: #2d3436;">‚è±Ô∏è <span id="time-result">0.0</span> saniye</div>
        </div>

        <div class="result-row">
            <span class="result-label">Olu≈üturulan ≈ûifreli Metin (Ciphertext):</span>
            <div id="cipher-result" class="result-value">-</div>
        </div>

        <div class="result-row" id="enc-key-row" style="display:none;">
            <span class="result-label">RSA ile ≈ûifrelenmi≈ü Anahtar:</span>
            <div id="enc-key-result" class="result-value" style="color: #fdcb6e; font-size: 0.8rem;">-</div>
        </div>

        <div class="result-row" style="border-top: 2px dashed #ccc; padding-top: 15px; margin-top:15px;">
            <span class="result-label">Server Baƒülantƒ± Durumu:</span>
            <span id="server-status" style="font-weight:bold;">-</span>
        </div>

        <div class="result-row">
            <span class="result-label">Server Tarafƒ±ndan √á√∂z√ºlen Metin (Plaintext):</span>
            <div id="server-plaintext" class="result-value" style="color: #fab1a0;">-</div>
        </div>

        <div class="result-row" id="server-reply-area" style="display:none; margin-top: 10px;">
            <span class="result-label">üì© Server'dan Gelen Cevap:</span>
            <div id="server-reply-decrypted" class="result-value" style="color: #55efc4; border: 2px solid #55efc4;">-</div>
            
            <span class="result-label" style="margin-top:5px;">üîë Server'ƒ±n Kullandƒ±ƒüƒ± Yeni Anahtar:</span>
            <div id="server-key-used" class="result-value" style="font-size: 0.85rem; color: #a29bfe;">-</div>
        </div>
    </div>
</div>

<script>
    let currentCiphertext = "";
    let currentEncryptedKey = null;
    let selectedFilename = null; // Dosya adƒ± saklamak i√ßin

    window.onload = function() { updatePlaceholder(); };

    // YENƒ∞: DOSYA ƒ∞≈ûLEME FONKSƒ∞YONU
    function handleFileUpload() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        const fileNameDisplay = document.getElementById('file-name-display');
        
        if (file) {
            selectedFilename = file.name; // Dosya adƒ±nƒ± sakla
            fileNameDisplay.innerText = "Se√ßilen Dosya: " + file.name + " (" + (file.size / 1024).toFixed(2) + " KB)";
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Base64 verisinin ba≈üƒ±ndaki "data:image/png;base64," kƒ±smƒ±nƒ± temizliyoruz
                // Sadece ham veriyi alƒ±yoruz
                const base64Content = e.target.result.split(',')[1];
                document.getElementById('text').value = base64Content;
                
                // Kullanƒ±cƒ±ya bilgi ver
                // alert("Dosya Base64 formatƒ±na √ßevrildi ve Mesaj kutusuna yazƒ±ldƒ±!");
            };
            
            reader.readAsDataURL(file); // Dosyayƒ± Base64 formatƒ±nda oku
        } else {
            selectedFilename = null;
            fileNameDisplay.innerText = "Hen√ºz dosya se√ßilmedi.";
        }
    }

    function resetForm() {
        updatePlaceholder();
        document.getElementById('sendBtn').disabled = true;
        document.getElementById('result-area').style.display = 'none';
        document.getElementById('server-reply-area').style.display = 'none';
        currentCiphertext = "";
        currentEncryptedKey = null;
        // Dosya se√ßimini sƒ±fƒ±rlama, kullanƒ±cƒ± belki aynƒ± dosyayƒ± ba≈üka modda denemek ister
    }

    function updatePlaceholder() {
        const algo = document.getElementById('algorithm').value;
        const hint = document.getElementById('key-hint');
        const keyInput = document.getElementById('key');
        
        keyInput.disabled = false;
        
        if(algo === 'aes') { hint.innerText = "16 Karakter (AES-128)"; keyInput.setAttribute("maxlength", "16"); }
        else if(algo === 'des') { hint.innerText = "8 Karakter (DES-64)"; keyInput.setAttribute("maxlength", "8"); }
        else if(algo === 'vernam') { hint.innerText = "‚ö†Ô∏è Metin uzunluƒüu kadar olmalƒ±!"; }
        else if(algo === 'root') { hint.innerText = "S√ºtun sayƒ±sƒ± (Sayƒ± girin)."; }
        else { hint.innerText = "Anahtar girin veya rastgele √ºretin."; keyInput.removeAttribute("maxlength"); }
    }

    async function generateRandomKey() {
        const algo = document.getElementById('algorithm').value;
        const text = document.getElementById('text').value;
        
        try {
            const response = await fetch('/generate_key', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    algorithm: algo,
                    text_length: text.length 
                })
            });
            const result = await response.json();
            if(result.status === 'success') {
                document.getElementById('key').value = result.key;
            } else {
                alert("Hata: " + result.message);
            }
        } catch(e) { alert("Baƒülantƒ± hatasƒ±: " + e); }
    }

    async function performEncrypt() {
        const algo = document.getElementById('algorithm').value;
        const mode = document.getElementById('mode').value;
        const text = document.getElementById('text').value;
        const key = document.getElementById('key').value;
        const sendBtn = document.getElementById('sendBtn');
        const cipherRes = document.getElementById('cipher-result');
        const encKeyRes = document.getElementById('enc-key-result');
        const timeRes = document.getElementById('time-result');

        sendBtn.disabled = true;
        if(!key) { alert("L√ºtfen anahtar girin."); return; }
        if(!text) { alert("Metin veya Dosya girin."); return; }

        try {
            const response = await fetch('/encrypt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ algorithm: algo, mode: mode, text: text, key: key })
            });

            const result = await response.json();
            const resArea = document.getElementById('result-area');
            resArea.style.display = 'block';
            
            if (result.status === 'success') {
                // Ciphertext √ßok uzun olabilir, hepsini g√∂sterme
                cipherRes.innerText = result.ciphertext.substring(0, 200) + "... (Toplam " + result.ciphertext.length + " karakter)";
                
                currentCiphertext = result.ciphertext;
                timeRes.innerText = result.duration; 
                
                if(result.encrypted_key) {
                    currentEncryptedKey = result.encrypted_key;
                    encKeyRes.innerText = result.encrypted_key.substring(0, 50) + "...";
                    document.getElementById('enc-key-row').style.display = 'flex';
                } else {
                    currentEncryptedKey = null;
                    document.getElementById('enc-key-row').style.display = 'none';
                }
                sendBtn.disabled = false;
                document.getElementById('server-status').innerText = "Bekleniyor...";
                document.getElementById('server-plaintext').innerText = "-";
                document.getElementById('server-reply-area').style.display = 'none';
            } else {
                cipherRes.innerHTML = `<span class="status-error">${result.message}</span>`;
            }
        } catch (error) { alert("Hata: " + error); }
    }

    async function sendToServer() {
        const algo = document.getElementById('algorithm').value;
        const mode = document.getElementById('mode').value;
        const statusSpan = document.getElementById('server-status');
        const plainSpan = document.getElementById('server-plaintext');
        const sendBtn = document.getElementById('sendBtn');
        const key = document.getElementById('key').value;

        statusSpan.innerText = "Dosya/Mesaj g√∂nderiliyor...";
        sendBtn.disabled = true;
        
        try {
            const response = await fetch('/send_to_server', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    algorithm: algo, 
                    mode: mode, 
                    ciphertext: currentCiphertext,
                    encrypted_key: currentEncryptedKey,
                    client_key: key,
                    filename: selectedFilename // Dosya adƒ±nƒ± g√∂nder
                })
            });

            const result = await response.json();
            
            if (result.status === 'success') {
                statusSpan.innerHTML = '<span class="status-success">‚úì BA≈ûARILI</span>';
                
                // Plaintext √ßok uzunsa kƒ±salt
                let plain = result.plaintext || "";
                if(plain.length > 200) plain = plain.substring(0, 200) + "... [Devamƒ± var]";
                plainSpan.innerText = plain;
                
                const replyArea = document.getElementById('server-reply-area');
                const replyVal = document.getElementById('server-reply-decrypted');
                const replyKeyVal = document.getElementById('server-key-used');
                
                replyArea.style.display = 'flex';
                replyArea.style.flexDirection = 'column';
                replyVal.innerText = result.server_reply_decrypted;
                replyKeyVal.innerText = result.server_key_used;

            } else {
                statusSpan.innerHTML = '<span class="status-error">‚úñ ' + (result.message || "Hata") + '</span>';
                plainSpan.innerText = "-";
            }
        } catch (error) {
            statusSpan.innerText = "Hata: Server ile ileti≈üim kurulamadƒ±.";
        } finally {
            sendBtn.disabled = false;
        }
    }
</script>

</body>
</html>